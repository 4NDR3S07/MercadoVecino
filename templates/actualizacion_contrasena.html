<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actualizar Contrase√±a</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/actualizacion_contrasena.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='imagenes/logo/logo_sin_fondo.png') }}" type="image/png">
</head>
<body>
    <div class="contenedor-principal">
        <!-- Ventana 1: Recuperar contrase√±a -->
        <div class="contenedor-izquierda" id="ventana-recuperar">
            <h2>Recuperar Contrase√±a</h2>
            <p>Ingresa tu correo para recibir el c√≥digo de confirmaci√≥n.</p>
            <form id="form-recuperar">
                <label for="email">Correo Electr√≥nico:</label>
                <input type="email" id="email" name="email" placeholder="correo@example.com" required>
                <button type="submit" class="boton-enviar">Enviar C√≥digo</button>
                <div id="mensaje-recuperar" style="color:#e74c3c; margin-top:8px;"></div>
            </form>
        </div>

        <!-- Ventana 2: Ingresar c√≥digo -->
        <div class="contenedor-izquierda" id="ventana-codigo" style="display:none;">
            <div class="logo-recuperar">
            </div>
            <h2>Ingresa el C√≥digo</h2>
            <p>Revisa tu correo y escribe el c√≥digo de verificaci√≥n y tu nueva contrase√±a.</p>
            <form id="form-codigo">
                <label for="codigo">C√≥digo de verificaci√≥n:</label>
                <input type="text" id="codigo" name="codigo" placeholder="123456" required>
                <label for="nueva_contrasena">Nueva contrase√±a:</label>
                <input type="password" id="nueva_contrasena" name="nueva_contrasena" placeholder="Nueva contrase√±a" required>
                <button type="submit" class="boton-enviar">Verificar</button>
                <div id="mensaje-codigo" style="color:#e74c3c; margin-top:8px;"></div>
            </form>
        </div>

<script>
   // ‚úÖ Variable global para recordar el email
let emailGlobal = "";

   // Paso 1: Enviar c√≥digo
document.getElementById('form-recuperar').addEventListener('submit', async function(e) {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const mensaje = document.getElementById('mensaje-recuperar');

    try {
        const res = await fetch('/actcontrase√±a', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ email })
        });

        const data = await res.json();
        console.log('Respuesta actcontrase√±a:', data);

        mensaje.textContent = data.message;
        mensaje.style.color = data.success ? 'green' : 'red';

        if (data.success) {
            emailGlobal = email; // üëà guardamos correo aqu√≠
            document.getElementById('ventana-recuperar').style.display = 'none';
            document.getElementById('ventana-codigo').style.display = 'block';
        }

    } catch (err) {
        console.error('Error en fetch /actcontrase√±a:', err);
        mensaje.textContent = 'Error inesperado al enviar el c√≥digo.';
        mensaje.style.color = 'red';
    }
});

// Paso 2: Verificar c√≥digo y actualizar contrase√±a
document.getElementById('form-codigo').addEventListener('submit', async function(e) {
    e.preventDefault();
    const codigo = document.getElementById('codigo').value.trim();
    const nueva_contrasena = document.getElementById('nueva_contrasena').value.trim();
    const mensaje = document.getElementById('mensaje-codigo');

    try {
        const res = await fetch('/verificar_codigo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ email: emailGlobal, codigo, nueva_contrasena })
    });

        const data = await res.json();
        console.log('Respuesta verificar_codigo:', data);

        mensaje.textContent = data.message;
        mensaje.style.color = data.success ? 'green' : 'red';

        if (data.success) {
            window.location.href = '/login.html';
        }
    } catch (err) {
        console.error('Error en fetch /verificar_codigo:', err);
        mensaje.textContent = 'Error inesperado al verificar.';
        mensaje.style.color = 'red';
    }
});
</script>
</body>
</html>